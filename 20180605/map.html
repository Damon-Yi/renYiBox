<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <link href="css/public.css" rel="stylesheet" type="text/css">
    <script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp&key=SEWBZ-VIQLF-63GJK-NOSXG-YU6ZO-ZNFY6&libraries=drawing,geometry,autocomplete,convertor"></script>
    <script src="./lib/jquery-2.1.4.js"></script>
    <script src="./lib/fastclick.js"></script>
    <style type="text/css">
        html,body {height: 100%;margin: 0px;padding: 0px;}
        #container {width: 100%;height: 100%}
        #center-icon{width: 21px;height: 37px;margin-top: -18px;}
        #center-icon>img{display:block;width: 100%;height: 100%;}
        #b-pannel{display:none;position:fixed; bottom:10px;left:2%;width: 96%;height: 150px;background-color:#fff;border-radius: 6px;z-index: 101 !important;}
        #b-center{position:fixed; bottom:20px;left:5px;width: 45px;height: 45px;border-radius: 50%;z-index: 100 !important;background:url(./img/reset.png) no-repeat 0 0 / contain;}
        #qa{position:fixed; bottom:20px;right:5px;width: 45px;height: 45px;border-radius: 50%;z-index: 100 !important;background:url(./img/qa.png) no-repeat 0 0 / contain;}
        #scan-btn{position:fixed; bottom:20px;left:50%;margin-left:-68px;width: 136px;height: 45px;z-index: 100 !important;background:url(./img/bt-bg.png) no-repeat 0 0 / contain;}
    </style>
</head>
<body>
    <!-- 地图 -->
    <div id="container"></div>
    <!-- 中心图标 -->
    <div id="center-icon"><img src="./img/self.png" alt=""></div>
    <!-- 底部面板 -->
    <div id="b-pannel"></div>
    <!-- 重置 -->
    <div id="b-center"></div>
    <!-- 扫码按钮 -->
    <div id="scan-btn"></div>
    <!-- 问题 -->
    <div id="qa"></div>
    <script type="text/javascript">
        var _MAP = qq.maps;

        pageUtils = {
            map: null,
            center:[39.98174,116.30631],
            zoom: 13,
            shops:[],   // 
            markers: [],
            currMarker: null,  // 当前选中图标
            init: function(){
                var _self = this;
                
                _self.initMap();
                _self.initControl();
                _self.bindEvents();
            },
            bindEvents: function(){
                var _self = this;

                $('#b-center').on('click', function(e){ // 返回中心
                    _self.resetMap();
                });

                $('#scan-btn').on('click', function(e){ // 扫码点击
                    console.log('saoma');
                });

                $('#qa').on('click', function(e){       // 问题点击
                    console.log('wenti');
                });
            },
            initMap: function(){ // 初始化地图
                var _self = this;

                var Map = _MAP.Map,
                Marker = _MAP.Marker,
                LatLng = _MAP.LatLng,
                Event = _MAP.event,
                MarkerAnimation = _MAP.MarkerAnimation,
                center = new LatLng(_self.center[0], _self.center[1]),
                options = {
                    center: center,
                    zoom: _self.zoom,
                    noClear: true,
                    backgroundColor: "#eeeef1",
                    mapTypeId: _MAP.MapTypeId.ROADMAP,
                    mapTypeControl: false,  // 地图类型控件，
                    panControl: false,      // 地图平移控件
                    zoomControl: false,
                    scaleControl: false,     // 地图比例尺控件
                    scaleControlOptions: {
                        position: _MAP.ControlPosition.BOTTOM_RIGHT
                    },
                    scrollwheel:true
                }
                // 初始化地图
                _self.map = new Map(document.getElementById("container"),options);   
                // 添加图标
                _self.addMarkers(_self.getPoints());   
                // 中心改变事件
                Event.addListener(_self.map, 'center_changed', function() { 
                    _self.addMarkers(_self.getPoints());    // 更新图标
                    _self.bPannel.css({'display':'none'});  // 隐藏底部面板
                });
                // 地图点击事件
                Event.addListener(_self.map, 'click', function() {  
                    _self.bPannel.css({'display':'none'});  // 隐藏底部面板
                });
                // 地图边界改变
                Event.addListener(_self.map, 'bounds_changed', function() {  
                    console.log(_self.map.getBounds().getNorthEast())
                }); 
            },
            initControl: function(){ // 初始化自定义控件
                var _self = this;

                //_self.addMarker('self', new _MAP.LatLng(_self.center[0], _self.center[1]), '');       // 中心位置图标
                var centerIcon = document.getElementById('center-icon');    
                    /*resetControl = document.getElementById('b-center'),     // 重置位置图标
                    scanCodeControl = document.getElementById('scan-btn'),  // 扫码位置
                    qaControl = document.getElementById('qa');  */            // 问题位置图标

                _self.map.controls[_MAP.ControlPosition.CENTER].push(centerIcon);
                /*_self.map.controls[_MAP.ControlPosition.BOTTOM_LEFT].push(resetControl);
                _self.map.controls[_MAP.ControlPosition.BOTTOM_CENTER].push(scanCodeControl);
                _self.map.controls[_MAP.ControlPosition.BOTTOM_RIGHT].push(qaControl);*/

                _self.bPannel = $('#b-pannel');
                /*_self.bPannel = document.getElementById('b-pannel');  // 底部面板
                _self.map.controls[_MAP.ControlPosition.BOTTOM_CENTER].push(_self.bPannel);*/
            },
            resetMap:function(){ // 重置地图位置
                var _self = this;
                var curCenter = _self.map.getCenter();
                if(curCenter.lat != _self.center[0] && curCenter.lng != _self.center[1]){ // 中心改变才重置
                    _self.map.panTo(new _MAP.LatLng(_self.center[0], _self.center[1]));
                    _self.map.zoomTo(_self.zoom);
                }
            },
            getPoints: function(){ // 获取图标数组
                var _self = this,
                    center = _self.map.getCenter(),
                    lat = center.lat,
                    lng = center.lng,
                    rat = 50,
                    size = 30;

                _self.shops = [];

                for(var i=0;i<size;i++){
                    var point = []
                    if(i<size/2){
                        point = [lat+Math.random()/rat, lng+Math.random()/rat];
                    }else{
                        point = [lat-Math.random()/rat, lng-Math.random()/rat];
                    }
                    _self.shops.push(point)
                }
                return _self.shops;
            },
            addMarkers: function(arr){ // 添加图标
                var _self = this;
                _self.removeMarkers();

                for(var i=0;i<arr.length;i++){
                    var pos = arr[i];
                    _self.addMarker('box', new _MAP.LatLng(pos[0], pos[1]),i);
                }
            },
            addMarker: function(type, position,data){ // 添加图标
                var _self = this;

                var marker = new _MAP.Marker({
                    position: position,
                    map: _self.map,
                });

                if(type === 'self'){
                    marker.setIcon(_self.getIcon(type, '', 42, 74)); // 未选中图标
                }else if(type === 'box'){
                    marker.setIcon(_self.getIcon(type, '', 85, 92)); // 未选中图标

                    _self.markers.push(marker);

                    _MAP.event.addListener(marker, 'click', function(e) {
                        //console.log(e,marker,data)
                        marker.setIcon(_self.getIcon(type, 'on', 85, 92)); // 选中图标
                        marker.setZIndex(1);

                        if(_self.currMarker && _self.currMarker!=marker){ // 更换图标
                            _self.currMarker.setIcon(_self.getIcon('box', '', 85, 92)); // 未选中图标
                            _self.currMarker.setZIndex(0);
                        }

                        _self.currMarker = marker;

                       _self.updatePannel(data);    // 底部面板更新数据
                    });
                }
            },
            removeMarkers: function(){ // 移除图标
                var _self = this;
                _self.markers.forEach( v => {
                    v.setMap(null);
                })
                _self.markers = [];
            },
            updatePannel: function(data){ // 更新底部面板 
                var _self = this;
                _self.bPannel.html("地图中心为：" + _self.map.getCenter() + '<br/>当前index：' + data);
                _self.bPannel.css({'display':'block'});
                //console.log(_self.markers[data], _self.shops[data])
            },
            getIcon: function(type, style, width, height){ // type--'box','shop','self'; style--'on',''
                var url = './img/'+ type + (style=='on'?'-on':'') +'.png',
                    size = new _MAP.Size(width/2, height/2),
                    origin = _MAP.Point(0, 0),
                    anchor = _MAP.Point(0, 0),
                    scaleSize = new _MAP.Size(width/2, height/2);
                return new _MAP.MarkerImage(url, size, origin, anchor, scaleSize);
            }
        }

        window.onload = function(){
            pageUtils.init();
        };
    </script>
</body>
</html>
